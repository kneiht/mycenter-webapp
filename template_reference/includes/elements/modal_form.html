<!-- Modal -->
<div class="modal fade" id="modalForm" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">{{ modal_name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div id="urlAPI" data="{{ url_api }}"></div>
      <div id="modelName" data="{{ model_name }}"></div>
      <div id="isNew" data="{{ is_new }}"></div>
      <div class="modal-body">
        <form method="post" enctype="multipart/form-data" id="formInsideModal">
          {% csrf_token %}
          <input id="id_id" name="id" value="{{ id_record }}" hidden>
          <div class="container">
            <div class="row">
              {% for field in form %}
              {% if field.label %}
              <div class="col-md-6 mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }} {% if field.help_text %}
                <small class="form-text text-muted">{{ field.help_text }}</small> {% endif %} {% for error in field.errors %}
                <div class="invalid-feedback">
                  {{ error }}
                </div>
                {% endfor %}
              </div>
              {% endif %}
              {% endfor %}
            </div>

            {% if is_class_modal_form %}
            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Select students</label>
                    <div class='form-control' style="width: 100%; height: 200px; overflow-y: scroll;">
                      <table class="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th style="text-align: center;">Select</th>
                                <th style="text-align: center;">Chargeable</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td>{{ student.id }} - {{ student.name }}</td>
                                <td style="text-align: center;">
                                    <input type="checkbox" class="student-checkbox" name="selected_students" value="{{ student.id }}"
                                           {% if student in class_instance.students.all %} checked {% endif %}>
                                </td>

                                <td style="text-align: center;">
                                    <input type="checkbox" class="paid-class-checkbox" name="paid_class_students" value="{{ student.id }}"
                                           {% if student in paid_class_students %} checked {% endif %}
                                           {% if student not in class_instance.students.all or not id_record %} disabled {% endif %}>
                                </td>

                            </tr>
                            {% endfor %}
                        </tbody>

                      </table>
                  </div>
                </div>
            </div>
            {% endif %}


            {% if is_student_modal_form %}
            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Select classes</label>
                    <div class='form-control' style="width: 100%; height: 200px; overflow-y: scroll;">
                      <table class="table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th style="text-align: center;">Select</th>
                                <th style="text-align: center;">Chargeable</th>
                            </tr>
                        </thead>

                        <tbody>
                            {% for class_instance in classes %}
                            <tr>
                                <td>{{ class_instance.name }} - {{ class_instance.course }}</td>
                                <td style="text-align: center;">
                                    <input type="checkbox" class="class-checkbox" name="selected_classes" value="{{ class_instance.id }}"
                                           {% if class_instance in student.classes.all %} checked {% endif %}>
                                </td>

                                <td style="text-align: center;">
                                    <input type="checkbox" class="paid-class-checkbox" name="paid_classes" value="{{ class_instance.id }}"
                                           {% if class_instance in paid_classes %} checked {% endif %}
                                           {% if class_instance not in student.classes.all  or not id_record %} disabled {% endif %}>
                                </td>

                            </tr>
                            {% endfor %}
                        </tbody>

                      </table>
                  </div>
                </div>
            </div>
            {% endif %}



            {% if is_pay_tuition_modal_form %}
            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Previous tuition payments</label>
                    <div class='form-control' style="width: 100%; height: 200px; overflow-y: scroll;">
                      <table class="table">
                        <thead>
                        <tr>
                            <th>Create Date</th>
                            <th>Plan</th>
                            <th>Discount</th>
                            <th>Final Fee</th>
                            <th>Notes</th>
                            <th>Images</th>
                        </tr>
                        </thead>

                        <tbody>
                            {% for payment in previous_payments %}
                            <tr>
                                <td class="datetime-local">{{ payment.create_date|date:"d/m/Y" }}</td>
                                <td>{{ payment.tuition_plan }}</td>
                                <td>{{ payment.discount }}</td>
                                <td>{{ payment.final_fee }}</td>
                                <td>{{ payment.note }}</td>

                                <td>
                                <p class="text-sm mb-0">
                                  {% for image in payment.images.all %}
                                      <a href="{{ image.image.url }}" target="_blank"> 
                                        <span class="text-info text-sm me-3"> Image{{ forloop.counter }}</span>
                                      </a>
                                  {% endfor %}
                                </p>
                                </td>

                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">
                                No previous tuition payments</td>
                            </tr>
                            {% endfor %}
                        </tbody>

                      </table>
                  </div>
                </div>
            </div>
            {% endif %}


            {% if is_financialtransaction_modal_form or is_pay_tuition_modal_form %}
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_for_label">Upload images</label>
                <input type="file" name="images" multiple class="form-control" accept="image/*" id="id_image">
                <small class="form-text text-muted">{{ field.help_text }}</small>
            </div>

            <!-- Container for image previews -->
            <div id="image_preview_container" class="container preview-image-wrapper">
                <!-- Image previews will be added here -->
            </div>
            {% else %}
            <!-- If the line below does not exist, js would not find id_image and fail to run -->
            <input type="file" name="images" id="id_image" hidden>
            {% endif %}

          </div>
        </form>
      </div>
<div class="modal-footer justify-content-center">
    
{% if is_attendance_modal_form and not is_new%}
  <button id="deleteRecord" type="button" class="btn btn-danger" data-bs-dismiss="modal">Delete</button>
{% endif %}
  <button id="saveFormInsideModal" type="button" class="btn btn-primary">Save changes</button>

  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>


</div>

    </div>
  </div>
</div>