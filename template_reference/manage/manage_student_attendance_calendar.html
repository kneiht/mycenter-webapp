{% extends "layouts/base_manage.html" %}
{% load static %}

{% block title %}
{{ student.name }} - Attendance calendar
{% endblock %}

{% block extra_style %}
<style>
  body {
    background-color: #f8f8f8; /* Soft UI often uses light, neutral backgrounds */
  }

  #calendar-container {
    background-color: #ffffff;
    border-radius: 15px; /* Soft UI typically has rounded corners */
    box-shadow: 0 8px 30px rgba(0,0,0,0.12); /* Soft UI uses subtle shadows for depth */
    overflow: hidden; /* Ensures the child elements adhere to the container's border radius */
    border: 1px solid #e0e0e0; /* Optional: adds a subtle border */
  }

  #weekdays, .week {
    display: flex;
    background: #ecf0f3; /* A light grey background for the weekdays header */
  }
  #weekdays .day, .week .day {
    flex: 1; /* Each cell will take up an equal amount of space */
    text-align: center;
    padding: 12px 0; /* Uniform padding for vertical alignment */
    color: #333;
    font-weight: 600; /* Slightly bolder font for better readability */
  }
  #weekdays .day {
    border-bottom: 1px solid #dcdcdc; /* A light border to separate header from the calendar body */
  }
  .week .day {
    position: relative;
    background-color: #fff; /* Soft UI elements often have a flat, light color */
    border-right: 1px solid #dcdcdc; /* Separators between days */
    border-bottom: 1px solid #dcdcdc; /* Separators between weeks */
  }
  .week .day:last-child {
    border-right: none; /* Remove the right border for the last day of the week */
  }
  .week:last-child .day {
    border-bottom: none; /* Remove the bottom border for the last week */
  }
  .week .day .date {
    margin-top: 0px; /* Space from the top of the cell */
    font-size: 0.8em;
  }
  .week .day .status {
    display: inline-block; /* Inline-block for automatic width */
    padding: 4px 7px;
    border-radius: 10px; /* Rounded corners for status labels */
    font-size: 0.8em;
    bottom: 10px;
    left: 50%;
    text-align: center;
     margin-top: 0.5em;
    font-weight: 500;
    cursor: pointer;
  }
  .week .day .status.present {
    margin: 5px; /* Space from the top of the cell */
    background-color: lightgreen; /* A soft green for presence */
  }
  .week .day .status.absent {
    margin: 5px; /* Space from the top of the cell */
    background-color: tomato; /* A soft red for absence */
  }

  .week .day .status.late {
    margin: 5px; /* Space from the top of the cell */
    background-color: lightblue; /* A soft red for absence */
  }
  .week .day .status.left_early {
    margin: 5px; /* Space from the top of the cell */
    background-color: plum; /* A soft red for absence */
  }


  /* Hover effect for days */
  .week .day:hover {
    background-color: #f6f6f6; /* A light hover state */
  }
</style>


{% endblock %}


{% block page_head_left %}
<h3> {{ student.name }} - Attendance  </h3>
{% endblock %}


{% block page_head_right %}
<!-- Button to Open Modal -->
<button type="button" class="create-modal-form btn btn-raised btn-primary no-wrap" data-id-record="" data-model-name="attendance" data-student-id="{{ student.id }}">Add new attendance </button>
{% endblock %}


{% block controls %}
<!-- Payment Selection Dropdown -->
<div class="col-xl-4 col-lg-5 col-md-6 d-flex align-items-center">
    <select id="paymentFilter" class="form-select">
        <option value="">Select Payment to Filter</option>
        {% for payment in payments %}
        <option value="{{ payment.id }}" {% if payment.id|stringformat:"s" == selected_payment_id %}selected{% endif %}>
            {{ payment }}
        </option>

        {% endfor %}
        <option value="unpaid">Unpaid lessons</option>
    </select>
</div>
{% endblock %}


{% block page_body %}
<div class="container-fluid pb-10">
    <div id="calendar-container">

        <!-- Instructions -->
        <div class="no-wrap my-2">
            <div class="d-flex justify-content-center align-items-center flex-wrap">
                <div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center;">
                    <span class="attendance-badge background-status-present">Present</span>
                    <span class="attendance-badge background-status-absent">Absent</span>
                    <span class="attendance-badge background-status-late">Late</span>
                    <span class="attendance-badge background-status-left_early">Left Early</span>
                </div>
            </div>
        </div>

        <div id="weekdays">
          <div class="day">Mon</div>
          <div class="day">Tue</div>
          <div class="day">Wed</div>
          <div class="day">Thu</div>
          <div class="day">Fri</div>
          <div class="day">Sat</div>
          <div class="day">Sun</div>
        </div>
      <div id="calendar">
        <!-- Calendar weeks and days here -->
      </div>
    </div>
</div>

{% endblock %}




{% block extra_script %}
{{ block.super }}
<script>
$(document).ready(function() {
    $('#paymentFilter').change(function() {
        var selectedPaymentId = $(this).val();
        var baseUrl = "{% url 'student_attendance_calendar' pk=student.id %}";
        if (selectedPaymentId) {
            window.location.href = baseUrl + '?payment_id=' + selectedPaymentId;
        } else {
            window.location.href = baseUrl;
        }
    });
});
</script>
<script type="text/javascript">
  // Parse the JSON data from the Django context
  var attendancesData = JSON.parse('{{ attendances_json|safe }}');

  $(document).ready(function() {
    var calendar = $('#calendar');

    // Helper function to format dates as YYYY-MM-DD
    function formatDate(date) {
      return ('0' + date.getDate()).slice(-2) + '-' +
             ('0' + (date.getMonth() + 1)).slice(-2) + '-' + 
             date.getFullYear();
    }

  // Helper function to get the start of the week (Monday)
function getWeekStartDate(inputDate) {
  // Ensure inputDate is a valid Date object
  if (!(inputDate instanceof Date)) {
    throw new Error("Invalid date input");
  }

  // Get the current day of the week (0-6, where 0 is Sunday)
  let currentDay = inputDate.getDay();

  // Calculate the difference between the current day and Monday
  let difference = currentDay - 1;

  // If the current day is Sunday (0), set the difference to 6 (Sunday to Monday)
  if (currentDay === 0) {
    difference = 6;
  }

  // Calculate the start of the week by subtracting the difference from the input date
  let weekStart = new Date(inputDate);
  weekStart.setDate(inputDate.getDate() - difference);

  return weekStart;
}


    // Find the start and end dates from the attendance data
    var sortedAttendances = attendancesData.sort((a, b) => new Date(a.check_date) - new Date(b.check_date));
    var startDate = getWeekStartDate(new Date(sortedAttendances[0].check_date));


    console.log(new Date(sortedAttendances[sortedAttendances.length - 1].check_date))
    var endDate = getWeekStartDate(new Date(sortedAttendances[sortedAttendances.length - 1].check_date));
    
    
    console.log(endDate)


    endDate.setDate(endDate.getDate() + 6); // End date should be the last day of the week



    // Loop through each week
    for (var weekStart = new Date(startDate); weekStart <= endDate; weekStart.setDate(weekStart.getDate() + 7)) {
      var weekDiv = $('<div class="week"></div>');
      
      // Loop through each day of the week
      for (var day = 0; day < 7; day++) {
        var weekDayDate = new Date(weekStart);
        weekDayDate.setDate(weekDayDate.getDate() + day);
        var dateStr = formatDate(weekDayDate);
        var dayDiv = $('<div class="day"></div>');
        dayDiv.append('<div class="date">' + dateStr + '</div>');

          // Find all attendances for this date
          var dailyAttendances = sortedAttendances.filter(function(a) {
            return formatDate(new Date(a.check_date)) === dateStr;
          });

          // If there are any attendances, display the status for each
          dailyAttendances.forEach(function(attendance) {

            var classType = attendance.is_paid_class ? " (Main)" : "";


            var statusClass = attendance.status.toLowerCase();
            var statusDiv = $('<div class="create-modal-form status ' + statusClass + '" data-id-record="' + attendance.id + '" data-model-name="attendance">' + 
                              attendance.check_class__name + ' (' + 
                              attendance.learning_hours + 'h)' + 
                              classType + '</div>');
            dayDiv.append(statusDiv);
          });

        // Append the day div to the week div
        weekDiv.append(dayDiv);
      }

      // Append the week div to the calendar
      calendar.append(weekDiv);
    }
  });
</script>

        

{% endblock %}




